#https://s3.eu-central-1.amazonaws.com/dh.cform-templates/openvpn/dh.cform.openvpn-launch-pub-stage2.yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Launch Template EC2 Server for OpenVPN Implementation.
  A Nested Stack that comprises: 
  Bla Bla.
  Inputs include:
  Bla Bla.
  Outputs include:
  Bla Bla.
#-------------------------------------------


Metadata: {}


Parameters:
#===========================================

#--- AMI for EC2 instance
#-------------------------------------------
  PublicAmiId:
    Description: Public AMI ID
    Type: AWS::EC2::Image::Id
#-------------------------------------------

#--- Public Subnet ID
#-------------------------------------------
  PublicSubnetIdA:
    Description: Public Subnet ID AZ-A
    Type: AWS::EC2::Subnet::Id
#-------------------------------------------

#--- Public Security Group Resource ID
#-------------------------------------------
  PublicSgResourceId:
    Description: Public Security Group ID AZ-A
    Type: AWS::EC2::SecurityGroup::Id
#-------------------------------------------


Conditions: {}


Resources:
#===========================================


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# PUBLIC EC2 DEFINITION
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


#--- Public EC2 Instance
#-------------------------------------------
  PublicEC2Instance:
    Type: AWS::EC2::Instance
#.............................
    CreationPolicy:
      ResourceSignal:    
        Count: 1
        Timeout: "PT5M"
#.............................
    Properties:
#.............................
      Tags:
        -
          Key: "Name"
          Value: "openvpn-public-2"
#.............................
      AvailabilityZone:
        'Fn::Select':
          - '0'
          - 'Fn::GetAZs':
              Ref: 'AWS::Region'
#.............................
      DisableApiTermination: false
      IamInstanceProfile: "dh.InstProfile.Managed.SysAdmin"
      ImageId: !Ref PublicAmiId
#      ImageId: "ami-0d4c3eabb9e72650a"
      InstanceType: "t2.nano"
#      InstanceType: "t2.micro"
      KeyName: !Sub "dh.SSH.Default_${AWS::Region}"
      Monitoring: false
#      SubnetId:
#        Ref: PublicSubnetIdA
#      SecurityGroupIds:
#        - !Ref PublicSgResourceId
#.............................
      BlockDeviceMappings: 
      - 
        DeviceName: "/dev/xvda"
        Ebs: 
          Encrypted: true
          VolumeSize: 8
          VolumeType: "gp2"
          DeleteOnTermination: true
#.............................
      NetworkInterfaces: 
      - 
        Description: "Primary Public NIC"
        DeleteOnTermination: true
        DeviceIndex: 0
        PrivateIpAddress: 10.0.128.20
        SubnetId: !Ref PublicSubnetIdA
        GroupSet: 
          - !Ref PublicSgResourceId
#.............................
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -xe
            # Update Packages, inc. aws-cfn-bootstrap
            yum update -y
            # Start cfn-init
            /opt/aws/bin/cfn-init -v --configsets Step1 --stack ${AWS::StackId} --resource PublicEC2Instance --region ${AWS::Region} || error_exit 'Failed to run cfn-init'
            # Start up the cfn-hup daemon to listen for changes to the EC2 instance metadata
            #/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'
            # All done so signal success
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource PublicEC2Instance --region ${AWS::Region}
#.............................
    Metadata:
      Comment: Metadata description here.
#,,,,,,,,,,,,,,,,,,,,,,,,,,,,

      AWS::CloudFormation::Authentication: 
        rolebased: 
          type: "S3"
          buckets: 
            - "dh.scripts"
          roleName: "dh.InstProfile.Managed.SysAdmin"
#,,,,,,,,,,,,,,,,,,,,,,,,,,,,

      AWS::CloudFormation::Init:
        configSets:
          Step1:
            - configOpenvpn

        configOpenvpn:
          sources:
            /etc/openvpn/server: "https://s3.eu-central-1.amazonaws.com/dh.scripts/easyrsa/openvpn/issued-certs/dh.easyrsa.openvpn.issued-certs.server.tar.gz"
          commands:
            1a_udp1194:
              command: "systemctl enable openvpn-server@dh.vpn.server.udp1194"
            1b_udp1194:
              command: "systemctl start openvpn-server@dh.vpn.server.udp1194"
            2a_tcp1194:
              command: "systemctl enable openvpn-server@dh.vpn.server.tcp1194"
            2b_tcp1194:
              command: "systemctl start openvpn-server@dh.vpn.server.tcp1194"

#,,,,,,,,,,,,,,,,,,,,,,,,,,,,


#-------------------------------------------



#Outputs: {}
Outputs:
#===========================================


#--- Public Instance ID
#-------------------------------------------
  Pub2EC2InstanceId:
    Description: Public Instance ID
    Value:
      Ref: PublicEC2Instance
#-------------------------------------------